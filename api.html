
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>Using the API &#8212; Stomp 8.0.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Using the Command-line client application" href="commandline.html" />
    <link rel="prev" title="Introduction to Stomp.py" href="intro.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="using-the-api">
<h1>Using the API<a class="headerlink" href="#using-the-api" title="Permalink to this heading">¶</a></h1>
<section id="establishing-a-connection">
<h2>Establishing a connection<a class="headerlink" href="#establishing-a-connection" title="Permalink to this heading">¶</a></h2>
<p>The simplest way to establish a connection, assuming the message broker is running on the local machine, is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">stomp</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">stomp</span><span class="o">.</span><span class="n">Connection</span><span class="p">([(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">62613</span><span class="p">)])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>By default this represents a STOMP 1.1 connection. You can request a specific version of the connection using one of the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">stomp</span><span class="o">.</span><span class="n">Connection10</span><span class="p">([(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">62613</span><span class="p">)])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">stomp</span><span class="o">.</span><span class="n">Connection11</span><span class="p">([(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">62613</span><span class="p">)])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">stomp</span><span class="o">.</span><span class="n">Connection12</span><span class="p">([(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">62613</span><span class="p">)])</span>
</pre></div>
</div>
<p>The first parameter to a <code class="docutils literal notranslate"><span class="pre">Connection</span></code> is <code class="docutils literal notranslate"><span class="pre">host_and_ports</span></code>. This is a list of tuples, each containing ip address (which could be an ipv6 address) and the port where the message broker is listening for stomp connections. The general idea with the list is to try each address until a successful socket connection is established (giving the ability to provide multiple brokers for failover).</p>
<p>An example of setting up a connection with failover addresses might be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">stomp</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">stomp</span><span class="o">.</span><span class="n">Connection</span><span class="p">([(</span><span class="s1">&#39;192.168.1.100&#39;</span><span class="p">,</span> <span class="mi">61613</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;192.168.1.101&#39;</span><span class="p">,</span> <span class="mi">62613</span><span class="p">)])</span>
</pre></div>
</div>
<p>And here’s an example of an ipv6 connection:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">stomp</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">stomp</span><span class="o">.</span><span class="n">Connection</span><span class="p">([</span><span class="s1">&#39;fe80::a00:27ff:fe90:3f1a</span><span class="si">%e</span><span class="s1">n1&#39;</span><span class="p">,</span> <span class="mi">62613</span><span class="p">])</span>
</pre></div>
</div>
<p>There are a number of other parameters for initialising the connection (looking at the StompConnection12 class):</p>
<blockquote>
<div><dl class="py class">
<dt class="sig sig-object py" id="stomp.connect.StompConnection12">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">stomp.connect.</span></span><span class="sig-name descname"><span class="pre">StompConnection12</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">host_and_ports</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prefer_localhost</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">try_loopback_connect</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reconnect_sleep_initial</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reconnect_sleep_increase</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.5</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reconnect_sleep_jitter</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">0.1</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reconnect_sleep_max</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">60.0</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">reconnect_attempts_max</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">3</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">timeout</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">heartbeats</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">(0,</span> <span class="pre">0)</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">keepalive</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">vhost</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">auto_decode</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">encoding</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'utf-8'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">auto_content_length</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">heart_beat_receive_scale</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">1.5</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">bind_host_port</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#stomp.connect.StompConnection12" title="Permalink to this definition">¶</a></dt>
<dd><p>Represents a 1.2 connection (comprising transport plus 1.2 protocol class).
See <a class="reference internal" href="stomp.html#stomp.transport.Transport" title="stomp.transport.Transport"><code class="xref py py-class docutils literal notranslate"><span class="pre">stomp.transport.Transport</span></code></a> for details on the initialisation parameters.</p>
</dd></dl>

</div></blockquote>
<p>The final step is to call the <code class="docutils literal notranslate"><span class="pre">connect</span></code> method (corresponding to the <a class="reference external" href="https://stomp.github.io/stomp-specification-1.2.html#CONNECT_or_STOMP_Frame">CONNECT frame</a>):</p>
<blockquote>
<div><dl class="py method">
<dt class="sig sig-object py" id="stomp.protocol.Protocol12.connect">
<span class="sig-prename descclassname"><span class="pre">Protocol12.</span></span><span class="sig-name descname"><span class="pre">connect</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">username</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">passcode</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">wait</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">headers</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">with_connect_command</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">False</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">keyword_headers</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#stomp.protocol.Protocol12.connect" title="Permalink to this definition">¶</a></dt>
<dd><p>Send a STOMP CONNECT frame. Differs from 1.0 and 1.1 versions in that the HOST header is enforced.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>username</strong> (<em>str</em>) – optionally specify the login user</p></li>
<li><p><strong>passcode</strong> (<em>str</em>) – optionally specify the user password</p></li>
<li><p><strong>wait</strong> (<em>bool</em>) – wait for the connection to complete before returning</p></li>
<li><p><strong>headers</strong> (<em>dict</em>) – a map of any additional headers to send with the subscription</p></li>
<li><p><strong>with_connect_command</strong> – if True, use CONNECT command instead of STOMP</p></li>
<li><p><strong>keyword_headers</strong> – any additional headers to send with the subscription</p></li>
</ul>
</dd>
</dl>
</dd></dl>

</div></blockquote>
<p>Note that connect also allows for a map (dict) of headers to be provided, and will merge these with any additional named parameters to build the headers for the <a class="reference external" href="https://stomp.github.io/stomp-specification-1.2.html#STOMP_Frames">STOMP frame</a>, allowing for non-standard headers to be transmitted to the broker.</p>
</section>
<section id="sending-and-receiving-messages">
<h2>Sending and receiving messages<a class="headerlink" href="#sending-and-receiving-messages" title="Permalink to this heading">¶</a></h2>
<p>Once the connection is established, you can send messages using the <code class="docutils literal notranslate"><span class="pre">send</span></code> method:</p>
<blockquote>
<div><dl class="py method">
<dt class="sig sig-object py" id="stomp.protocol.Protocol12.send">
<span class="sig-prename descclassname"><span class="pre">Protocol12.</span></span><span class="sig-name descname"><span class="pre">send</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">destination</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">body</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">content_type</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">headers</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">keyword_headers</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#stomp.protocol.Protocol12.send" title="Permalink to this definition">¶</a></dt>
<dd><dl class="simple">
<dt>Send a message to a destination in the messaging system (as per</dt><dd><p><a class="reference external" href="https://stomp.github.io/stomp-specification-1.2.html#SEND">https://stomp.github.io/stomp-specification-1.2.html#SEND</a>)</p>
</dd>
</dl>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><p><strong>destination</strong> (<em>str</em>) – the destination (such as a message queue - for example</p>
</dd>
</dl>
<p>‘/queue/test’ - or a message topic)
:param body: the content of the message
:param str content_type: the MIME type of message
:param dict headers: additional headers to send in the message frame
:param keyword_headers: any additional headers the broker requires</p>
</dd></dl>

</div></blockquote>
<p>To receive messages back from the messaging system, you need to setup some sort of listener on your connection, and then subscribe to the destination (see <a class="reference external" href="https://stomp.github.io/stomp-specification-1.2.html#SUBSCRIBE">STOMP subscribe</a>). Listeners are simply a subclass which implements the methods in the ConnectionListener class (see <a class="reference external" href="stomp.html#module-stomp.listener">this page</a> for more detail). Stomp provides a few implementations of listeners, but the simplest is <code class="docutils literal notranslate"><span class="pre">PrintingListener</span></code> which just prints all interactions between the client and server. A simple example of this in action is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">stomp</span> <span class="kn">import</span> <span class="o">*</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span> <span class="o">=</span> <span class="n">Connection</span><span class="p">([(</span><span class="s1">&#39;127.0.0.1&#39;</span><span class="p">,</span> <span class="mi">62613</span><span class="p">)])</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">set_listener</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">PrintingListener</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;admin&#39;</span><span class="p">,</span> <span class="s1">&#39;password&#39;</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="go">on_connecting 127.0.0.1 62613</span>
<span class="go">on_send STOMP {&#39;passcode&#39;: &#39;password&#39;, &#39;login&#39;: &#39;admin&#39;, &#39;accept-version&#39;: &#39;1.2&#39;, &#39;host&#39;: &#39;127.0.0.1&#39;}</span>
<span class="go">on_connected {&#39;server&#39;: &#39;apache-apollo/1.7.1&#39;, &#39;host-id&#39;: &#39;mybroker&#39;, &#39;session&#39;: &#39;mybroker-13e0&#39;, &#39;heart-beat&#39;: &#39;100,10000&#39;, &#39;version&#39;: &#39;1.2&#39;, &#39;user-id&#39;: &#39;admin&#39;}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s1">&#39;/queue/test&#39;</span><span class="p">,</span> <span class="mi">123</span><span class="p">)</span>
<span class="go">on_send SUBSCRIBE {&#39;id&#39;: 123, &#39;ack&#39;: &#39;auto&#39;, &#39;destination&#39;: &#39;/queue/test&#39;}</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;/queue/test&#39;</span><span class="p">,</span> <span class="s1">&#39;a test message&#39;</span><span class="p">)</span>
<span class="go">on_send SEND {&#39;content-length&#39;: 5, &#39;destination&#39;: &#39;/queue/test&#39;} b&#39;a test message&#39;</span>
<span class="go">on_before_message {&#39;destination&#39;: &#39;/queue/test&#39;, &#39;message-id&#39;: &#39;mybroker-13e01&#39;, &#39;subscription&#39;: &#39;123&#39;, &#39;ack&#39;: &#39;2&#39;, &#39;content-length&#39;: &#39;5&#39;} a test message</span>
<span class="go">on_message {&#39;destination&#39;: &#39;/queue/test&#39;, &#39;message-id&#39;: &#39;mybroker-13e01&#39;, &#39;subscription&#39;: &#39;123&#39;, &#39;ack&#39;: &#39;2&#39;, &#39;content-length&#39;: &#39;5&#39;} a test message</span>
</pre></div>
</div>
<p>You can see the responses from the message system in the <code class="docutils literal notranslate"><span class="pre">on_connected</span></code>, and <code class="docutils literal notranslate"><span class="pre">on_message</span></code> output. The stomp frames sent to the server can be seen in each <code class="docutils literal notranslate"><span class="pre">on_send</span></code> output (an initial STOMP connect frame, SUBSCRIBE and then SEND).</p>
<p>In the case of the subscribe method, as of STOMP 1.1, the <code class="docutils literal notranslate"><span class="pre">id</span></code> parameter is required (if connecting with STOMP 1.0, only the destination is required):</p>
<blockquote>
<div><dl class="py method">
<dt class="sig sig-object py" id="stomp.protocol.Protocol12.subscribe">
<span class="sig-prename descclassname"><span class="pre">Protocol12.</span></span><span class="sig-name descname"><span class="pre">subscribe</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">destination</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">id</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">ack</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'auto'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">headers</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="o"><span class="pre">**</span></span><span class="n"><span class="pre">keyword_headers</span></span></em><span class="sig-paren">)</span><a class="headerlink" href="#stomp.protocol.Protocol12.subscribe" title="Permalink to this definition">¶</a></dt>
<dd><p>Subscribe to a destination</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters<span class="colon">:</span></dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>destination</strong> (<em>str</em>) – the topic or queue to subscribe to</p></li>
<li><p><strong>id</strong> (<em>str</em>) – the identifier to uniquely identify the subscription</p></li>
<li><p><strong>ack</strong> (<em>str</em>) – either auto, client or client-individual</p></li>
</ul>
</dd>
</dl>
<p>(see <a class="reference external" href="https://stomp.github.io/stomp-specification-1.2.html#SUBSCRIBE">https://stomp.github.io/stomp-specification-1.2.html#SUBSCRIBE</a> for more info)
:param dict headers: a map of any additional headers to send with the subscription
:param keyword_headers: any additional headers to send with the subscription</p>
</dd></dl>

</div></blockquote>
<p>Note that listeners can be named so you can use more that one type of listener at the same time:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">set_listener</span><span class="p">(</span><span class="s1">&#39;stats&#39;</span><span class="p">,</span> <span class="n">StatsListener</span><span class="p">())</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">set_listener</span><span class="p">(</span><span class="s1">&#39;print&#39;</span><span class="p">,</span> <span class="n">PrintingListener</span><span class="p">())</span>
</pre></div>
</div>
<p>You unsubscribe from a topic or queue using the unique <code class="docutils literal notranslate"><span class="pre">id</span></code> for the subscription:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s1">&#39;/queue/test&#39;</span><span class="p">,</span> <span class="mi">123</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">c</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="mi">123</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="acks-and-nacks">
<h2>Acks and Nacks<a class="headerlink" href="#acks-and-nacks" title="Permalink to this heading">¶</a></h2>
<p>Acknowledgements are a way to tell the message server that a message was either consumed, or not. Assume a collection of clients on a server listening on a queue, and a message which requires significant processing. One of the clients receives the message, checks resource usage on the server and decides to send a nack as a consequence. The message server could, at that point, decide to send to a failover server for processing (that’s a possible use, anyway).</p>
<p>Use the client or client-individual acknowledgement parameter (see <a class="reference external" href="https://stomp.github.io/stomp-specification-1.2.html#SUBSCRIBE_ack_Header">here</a> for a description) with the subscription, in order to use acks and nacks. Afterwards, you use the message and subscription ids to ack or nack the message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s1">&#39;/queue/test&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">ack</span><span class="o">=</span><span class="s1">&#39;client&#39;</span><span class="p">)</span>
<span class="go">on_before_message {&#39;message-id&#39;: &#39;mybroker-14aa2&#39;, &#39;destination&#39;: &#39;/queue/test&#39;, &#39;subscription&#39;: &#39;4&#39;, &#39;content-length&#39;: &#39;14&#39;} test message 1</span>
<span class="go">on_message {&#39;message-id&#39;: &#39;mybroker-14aa2&#39;, &#39;destination&#39;: &#39;/queue/test&#39;, &#39;subscription&#39;: &#39;4&#39;, &#39;content-length&#39;: &#39;14&#39;} test message 1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">ack</span><span class="p">(</span><span class="s1">&#39;mybroker-14aa2&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="go">on_before_message {&#39;message-id&#39;: &#39;mybroker-14ab2&#39;, &#39;destination&#39;: &#39;/queue/test&#39;, &#39;subscription&#39;: &#39;4&#39;, &#39;content-length&#39;: &#39;14&#39;} test message 2</span>
<span class="go">on_message {&#39;message-id&#39;: &#39;mybroker-14ab2&#39;, &#39;destination&#39;: &#39;/queue/test&#39;, &#39;subscription&#39;: &#39;4&#39;, &#39;content-length&#39;: &#39;14&#39;} test message 2</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">nack</span><span class="p">(</span><span class="s1">&#39;mybroker-14ab2&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="transactions">
<h2>Transactions<a class="headerlink" href="#transactions" title="Permalink to this heading">¶</a></h2>
<p>The STOMP protocol provides a way to transmit messages to a broker inside a transaction, which are held on the server until the transaction is either committed - at which point they’re sent - or aborted - where the messages are discarded.</p>
<p>Begin a transaction using the <code class="docutils literal notranslate"><span class="pre">begin</span></code> method, which returns the transaction id you then use when sending messages (you can also generate your own transaction id and pass that as a parameter to <code class="docutils literal notranslate"><span class="pre">begin</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s1">&#39;/queue/test&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">txid</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;/queue/test&#39;</span><span class="p">,</span> <span class="s1">&#39;test1&#39;</span><span class="p">,</span> <span class="n">transaction</span><span class="o">=</span><span class="n">txid</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;/queue/test&#39;</span><span class="p">,</span> <span class="s1">&#39;test2&#39;</span><span class="p">,</span> <span class="n">transaction</span><span class="o">=</span><span class="n">txid</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;/queue/test&#39;</span><span class="p">,</span> <span class="s1">&#39;test3&#39;</span><span class="p">,</span> <span class="n">transaction</span><span class="o">=</span><span class="n">txid</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">(</span><span class="n">txid</span><span class="p">)</span>

<span class="go">on_message {&#39;subscription&#39;: &#39;5&#39;, &#39;content-length&#39;: &#39;5&#39;, &#39;destination&#39;: &#39;/queue/test&#39;, &#39;message-id&#39;: &#39;mybroker-14b03&#39;, &#39;transaction&#39;: &#39;b39f3136-46a3-4e11-8ba8-845e36d48412&#39;} test1</span>
<span class="go">on_message {&#39;subscription&#39;: &#39;5&#39;, &#39;content-length&#39;: &#39;5&#39;, &#39;destination&#39;: &#39;/queue/test&#39;, &#39;message-id&#39;: &#39;mybroker-14b04&#39;, &#39;transaction&#39;: &#39;b39f3136-46a3-4e11-8ba8-845e36d48412&#39;} test2</span>
<span class="go">on_message {&#39;subscription&#39;: &#39;5&#39;, &#39;content-length&#39;: &#39;5&#39;, &#39;destination&#39;: &#39;/queue/test&#39;, &#39;message-id&#39;: &#39;mybroker-14b05&#39;, &#39;transaction&#39;: &#39;b39f3136-46a3-4e11-8ba8-845e36d48412&#39;} test3</span>
</pre></div>
</div>
<p>Abort a transaction (and discard the sent messages using <code class="docutils literal notranslate"><span class="pre">abort</span></code>):</p>
<div class="doctest highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s1">&#39;/queue/test&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">6</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">txid</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">begin</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;/queue/test&#39;</span><span class="p">,</span> <span class="s1">&#39;test4&#39;</span><span class="p">,</span> <span class="n">transaction</span><span class="o">=</span><span class="n">txid</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;/queue/test&#39;</span><span class="p">,</span> <span class="s1">&#39;test5&#39;</span><span class="p">,</span> <span class="n">transaction</span><span class="o">=</span><span class="n">txid</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">abort</span><span class="p">(</span><span class="n">txid</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="disconnect">
<h2>Disconnect<a class="headerlink" href="#disconnect" title="Permalink to this heading">¶</a></h2>
<p>Stomp.py supports graceful shutdown/disconnections through a receipt parameter (automatically generated if you don’t provide it). The connection is only dropped when the server sends back a response to that receipt:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">conn</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
<span class="go">on_send DISCONNECT {&#39;receipt&#39;: &#39;825a5cd6-9e3c-4a72-8051-72348a94f5ce&#39;}</span>
<span class="go">on_receipt {&#39;receipt-id&#39;: &#39;825a5cd6-9e3c-4a72-8051-72348a94f5ce&#39;}</span>
<span class="go">on_disconnected</span>
</pre></div>
</div>
</section>
<section id="dealing-with-disconnects">
<h2>Dealing with disconnects<a class="headerlink" href="#dealing-with-disconnects" title="Permalink to this heading">¶</a></h2>
<p>You can use a listener to deal with connection failures, and gracefully reconnect.  Consider the below ‘server’ code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">stomp</span>

<span class="k">def</span> <span class="nf">connect_and_subscribe</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;guest&#39;</span><span class="p">,</span> <span class="s1">&#39;guest&#39;</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">destination</span><span class="o">=</span><span class="s1">&#39;/queue/test&#39;</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ack</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyListener</span><span class="p">(</span><span class="n">stomp</span><span class="o">.</span><span class="n">ConnectionListener</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">conn</span> <span class="o">=</span> <span class="n">conn</span>

    <span class="k">def</span> <span class="nf">on_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;received an error &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_message</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;received a message &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="n">frame</span><span class="o">.</span><span class="n">body</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;processed message&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">on_disconnected</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;disconnected&#39;</span><span class="p">)</span>
        <span class="n">connect_and_subscribe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">conn</span><span class="p">)</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">stomp</span><span class="o">.</span><span class="n">Connection</span><span class="p">([(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">62613</span><span class="p">)],</span> <span class="n">heartbeats</span><span class="o">=</span><span class="p">(</span><span class="mi">4000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">))</span>
<span class="n">conn</span><span class="o">.</span><span class="n">set_listener</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">MyListener</span><span class="p">(</span><span class="n">conn</span><span class="p">))</span>
<span class="n">connect_and_subscribe</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
<span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">60</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</pre></div>
</div>
<p>The listener in this code has an, arguably broken, message handler (on_message) which takes longer to process than the heartbeat time of 4 seconds (4000); resulting in a heartbeat timeout when a message is received, and a subsequent disconnect. The on_disconnected method then reconnects and continues processing. You can test the results of this by running the above code, and sending a message using the following ‘client’:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">stomp</span>
<span class="n">conn</span> <span class="o">=</span> <span class="n">stomp</span><span class="o">.</span><span class="n">Connection</span><span class="p">([(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">62613</span><span class="p">)])</span>
<span class="n">conn</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s1">&#39;guest&#39;</span><span class="p">,</span> <span class="s1">&#39;guest&#39;</span><span class="p">,</span> <span class="n">wait</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">conn</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;/queue/test&#39;</span><span class="p">,</span> <span class="s1">&#39;test message&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">Stomp</a></h1>








<h3>Navigation</h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quick start</a></li>
<li class="toctree-l1"><a class="reference internal" href="intro.html">Introduction to Stomp.py</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Using the API</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#establishing-a-connection">Establishing a connection</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sending-and-receiving-messages">Sending and receiving messages</a></li>
<li class="toctree-l2"><a class="reference internal" href="#acks-and-nacks">Acks and Nacks</a></li>
<li class="toctree-l2"><a class="reference internal" href="#transactions">Transactions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#disconnect">Disconnect</a></li>
<li class="toctree-l2"><a class="reference internal" href="#dealing-with-disconnects">Dealing with disconnects</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="commandline.html">Using the Command-line client application</a></li>
<li class="toctree-l1"><a class="reference internal" href="otherprojects.html">Other Projects/References</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="intro.html" title="previous chapter">Introduction to Stomp.py</a></li>
      <li>Next: <a href="commandline.html" title="next chapter">Using the Command-line client application</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, Jason R Briggs.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/api.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>